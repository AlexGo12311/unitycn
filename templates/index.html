<!DOCTYPE html>
<html>
<head>
    <title>{{.title}}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .post {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            background: white;
        }

        .post:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .post-author {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .author-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .user-id {
            color: #999;
            font-size: 0.8em;
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .post-content {
            margin: 15px 0;
            line-height: 1.6;
            font-size: 1.05em;
            color: #333;
        }

        .post-stats {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 10px 0;
        }

        .likes-count, .comments-count {
            font-size: 0.9em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timestamp {
            color: #888;
            font-size: 0.85em;
        }

        .post-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .post-actions button {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .post-actions button:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .like-btn.active {
            background: #ffebee;
            border-color: #ffcdd2;
            color: #d32f2f;
        }

        #post-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        #post-form input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        #post-form input:focus {
            border-color: #d32f2f;
            outline: none;
        }

        #post-form button {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(211, 47, 47, 0.3);
        }

        #post-form button:hover {
            background: linear-gradient(135deg, #b71c1c 0%, #9a0007 100%);
            transform: translateY(-1px);
        }

        .comments-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .add-comment {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-comment textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .add-comment textarea:focus {
            border-color: #1976d2;
            outline: none;
        }

        .add-comment button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .add-comment button:hover {
            background: #1565c0;
        }

        .comments-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .comment {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #1976d2;
        }

        .comment-author {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-content {
            margin: 8px 0;
            color: #444;
            line-height: 1.5;
        }

        .comment-date {
            font-size: 0.8em;
            color: #888;
        }

        .no-comments, .loading {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }

        .error {
            color: #d32f2f;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .slogan {
            color: #d32f2f;
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .auth-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 0.9em;
        }

        .auth-info a {
            color: #1976d2;
            text-decoration: none;
            margin-left: 10px;
        }

        .auth-info a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{.title}}</h1>
            <div class="slogan">{{.slogan}}</div>
            <div class="auth-info" id="auth-info">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
            </div>
        </div>

        <h3>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç:</h3>
        <div id="post-form">
            <input type="text" id="post-content" placeholder="–¢–æ–≤–∞—Ä–∏—â, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –º—ã—Å–ª—è–º–∏ –æ –µ–¥–∏–Ω—Å—Ç–≤–µ –ø—Ä–æ–ª–µ—Ç–∞—Ä–∏–∞—Ç–∞...">
            <button onclick="createPost()">ÂèëÂ∏É (–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å)</button>
        </div>

        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã:</h3>
        <div id="posts-container">
            {{if .posts}}
                {{range .posts}}
                <div class="post" id="post-{{.ID}}">
                    <div class="post-author">
                        <div class="author-name">
                            {{if .User}}
                                {{if .User.DisplayName}}
                                    {{.User.DisplayName}}
                                {{else}}
                                    {{.User.Username}}
                                {{end}}
                            {{else}}
                                –ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ç–æ–≤–∞—Ä–∏—â
                            {{end}}
                        </div>
                        <div class="user-id">#{{.UserID}}</div>
                    </div>

                    <div class="post-content">{{.Content}}</div>

                    <div class="post-stats">
                        <div class="likes-count">
                            <span class="like-icon">üëç</span>
                            <span id="likes-{{.ID}}">{{.Likes}}</span> –≥–æ–ª–æ—Å–æ–≤
                        </div>
                        <div class="comments-count">
                            <span class="comment-icon">üí¨</span>
                            <span id="comments-count-{{.ID}}">{{.CommentsCount}}</span> –æ—Ç–≤–µ—Ç–æ–≤
                        </div>
                        <div class="timestamp">{{.CreatedAt.Format "02.01.2006 15:04"}}</div>
                    </div>

                    <div class="post-actions">
                        <button class="like-btn" data-post-id="{{.ID}}" onclick="likePost({{.ID}})">
                            –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å
                        </button>
                        <button class="comment-btn" data-post-id="{{.ID}}" onclick="toggleComments({{.ID}})">
                            –û—Ç–≤–µ—Ç–∏—Ç—å
                        </button>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div class="comments-section" id="comments-{{.ID}}" style="display: none;">
                        <div class="add-comment">
                            <textarea id="comment-input-{{.ID}}" 
                                      placeholder="–í–∞—à –æ—Ç–≤–µ—Ç —Ç–æ–≤–∞—Ä–∏—â—É..."></textarea>
                            <button onclick="addComment({{.ID}})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                        <div class="comments-list" id="comments-list-{{.ID}}">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>
                        </div>
                    </div>
                </div>
                {{end}}
            {{else}}
                <div class="no-posts">
                    <p>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –¢–æ–≤–∞—Ä–∏—â, –±—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø–æ–¥–µ–ª–∏—Ç—Å—è –º—ã—Å–ª—è–º–∏ –æ –ø—Ä–æ–ª–µ—Ç–∞—Ä—Å–∫–æ–º –µ–¥–∏–Ω—Å—Ç–≤–µ!</p>
                </div>
            {{end}}
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Communist Twitter...');
            updateAuthInfo();
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthInfo() {
            const authInfo = document.getElementById('auth-info');
            const token = localStorage.getItem('token');
            
            if (token) {
                try {
                    // –ü–∞—Ä—Å–∏–º —Ç–æ–∫–µ–Ω —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    authInfo.innerHTML = `
                        –¢–æ–≤–∞—Ä–∏—â: <strong>${payload.username}</strong>
                        <a href="#" onclick="logout()">–í—ã–π—Ç–∏</a>
                    `;
                } catch (e) {
                    authInfo.innerHTML = `
                        <a href="/login">–í–æ–π—Ç–∏</a>
                        <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    `;
                }
            } else {
                authInfo.innerHTML = `
                    <a href="/login">–í–æ–π—Ç–∏</a>
                    <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                `;
            }
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            localStorage.removeItem('token');
            alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã!');
            updateAuthInfo();
            location.reload();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
        async function createPost() {
            const content = document.getElementById('post-content').value.trim();
            const token = localStorage.getItem('token');

            if (!token) {
                alert('–¢–æ–≤–∞—Ä–∏—â, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏!');
                window.location.href = '/login';
                return;
            }

            if (!content) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, —Ç–æ–≤–∞—Ä–∏—â!');
                return;
            }

            if (content.length < 3) {
                alert('–ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
            button.disabled = true;

            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ content: content })
                });

                if (response.ok) {
                    document.getElementById('post-content').value = '';
                    alert('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // –õ–∞–π–∫ –ø–æ—Å—Ç–∞
        async function likePost(postId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–≤–∞—Ä–∏—â–∞!');
                window.location.href = '/login';
                return;
            }

            const button = document.querySelector(`[data-post-id="${postId}"]`);
            const originalText = button.textContent;
            button.textContent = '...';
            button.disabled = true;

            try {
                const response = await fetch(`/api/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                    const likesSpan = document.getElementById(`likes-${postId}`);
                    if (likesSpan) {
                        const currentLikes = parseInt(likesSpan.textContent) || 0;
                        likesSpan.textContent = result.liked ? currentLikes + 1 : currentLikes - 1;
                    }
                    
                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                    if (result.liked) {
                        button.classList.add('active');
                        button.textContent = '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–æ!';
                    } else {
                        button.classList.remove('active');
                        button.textContent = '–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å';
                    }
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 1500);
                    
                } else {
                    const error = await response.json();
                    alert(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ª–∞–π–∫–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
            } finally {
                button.disabled = false;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            const button = document.querySelector(`.comment-btn[data-post-id="${postId}"]`);
            
            if (commentsSection.style.display === 'none') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                commentsSection.style.display = 'block';
                button.textContent = '–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã';
                loadComments(postId);
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º
                commentsSection.style.display = 'none';
                button.textContent = '–û—Ç–≤–µ—Ç–∏—Ç—å';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        async function loadComments(postId) {
            const commentsList = document.getElementById(`comments-list-${postId}`);
            
            if (!commentsList) return;
            
            commentsList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>';
            
            try {
                const response = await fetch(`/api/posts/${postId}/comments`);
                if (response.ok) {
                    const comments = await response.json();
                    
                    if (comments.length === 0) {
                        commentsList.innerHTML = `
                            <div class="no-comments">
                                –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç —Ç–æ–≤–∞—Ä–∏—â—É!
                            </div>
                        `;
                    } else {
                        commentsList.innerHTML = comments.map(comment => `
                            <div class="comment" id="comment-${comment.id}">
                                <div class="comment-author">
                                    <span>${comment.user?.display_name || comment.user?.username || '–ê–Ω–æ–Ω–∏–º'}</span>
                                    <span class="comment-date">
                                        ${new Date(comment.created_at).toLocaleString('ru-RU')}
                                    </span>
                                </div>
                                <div class="comment-content">${comment.content}</div>
                            </div>
                        `).join('');
                    }
                } else {
                    commentsList.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
                commentsList.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        async function addComment(postId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä–∏—â—É!');
                window.location.href = '/login';
                return;
            }
            
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            
            if (!content) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞!');
                return;
            }
            
            if (content.length < 2) {
                alert('–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            button.disabled = true;
            
            try {
                const response = await fetch(`/api/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ content: content })
                });
                
                if (response.ok) {
                    input.value = '';
                    button.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                    loadComments(postId);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                    const commentsCount = document.getElementById(`comments-count-${postId}`);
                    if (commentsCount) {
                        const currentCount = parseInt(commentsCount.textContent) || 0;
                        commentsCount.textContent = currentCount + 1;
                    }
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 1000);
                    
                } else {
                    const error = await response.json();
                    alert(error.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
                button.textContent = originalText;
                button.disabled = false;
            }
        }
    </script>
</body>
</html>