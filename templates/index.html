<!DOCTYPE html>
<html>
<head>
    <title>{{.title}}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }

        .post {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
        }

        .slogan {
            color: #d32f2f;
            font-weight: bold;
        }

        .like-btn {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 10px;
        }

        .like-btn:hover {
            background: #e0e0e0;
        }

        .like-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .post-author {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .user-id {
            color: #999;
            font-size: 0.8em;
        }

        .post-content {
            margin: 10px 0;
            line-height: 1.5;
        }

        #post-form button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        #post-form button:hover {
            background: #b71c1c;
        }
        
        #post-form input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .post-stats {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            color: #666;
            font-size: 0.9em;
        }

        .post-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .post-actions button {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 4px;
        }

        .post-actions button:hover {
            background: #e0e0e0;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .add-comment {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-comment textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }

        .add-comment button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .comment {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid #1976d2;
        }

        .comment-author {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .comment-content {
            margin: 5px 0;
        }

        .comment-date {
            font-size: 0.8em;
            color: #888;
        }
    </style>
</head>
<body>
    <h1>{{.title}}</h1>
    <h2 class="slogan">{{.slogan}}</h2>

    <div style="margin: 20px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
        <strong>–¢–æ–≤–∞—Ä–∏—â:</strong> 
        <span id="auth-info">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
        </span>
    </div>

    <h3>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç:</h3>
    <div id="post-form">
        <input type="text" id="post-content" placeholder="–¢–æ–≤–∞—Ä–∏—â, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –º—ã—Å–ª—è–º–∏...">
        <button onclick="createPost()">ÂèëÂ∏É (–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å)</button>
    </div>

    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã:</h3>
    <div id="posts-container">
        {{if .posts}}
            {{range .posts}}
            <div class="post" id="post-{{.ID}}">
                <div class="post-author">
                    <strong>
                        {{if .User}}
                            {{if .User.DisplayName}}
                                {{.User.DisplayName}}
                            {{else}}
                                {{.User.Username}}
                            {{end}}
                        {{else}}
                            –ê–Ω–æ–Ω–∏–º
                        {{end}}
                    </strong>
                    <small class="user-id">ID: {{.UserID}}</small>
                </div>

                <div class="post-content">{{.Content}}</div>

                <div class="post-stats">
                    <span>üëç <span id="likes-{{.ID}}">{{.Likes}}</span></span>
                    <span class="timestamp">{{.CreatedAt.Format "02.01.2006 15:04"}}</span>
                </div>

                <div class="post-actions">
                    <button class="like-btn" data-post-id="{{.ID}}" onclick="likePost({{.ID}})">
                        –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å
                    </button>
                    <button class="comment-btn" onclick="toggleComments({{.ID}})">
                        –û—Ç–≤–µ—Ç–∏—Ç—å
                    </button>
                </div>

                <!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="comments-section" id="comments-{{.ID}}" style="display: none;">
                    <div class="add-comment">
                        <textarea id="comment-input-{{.ID}}" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="2"></textarea>
                        <button onclick="addComment({{.ID}})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                    <div class="comments-list" id="comments-list-{{.ID}}">
                        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>
                    </div>
                </div>
            </div>
            {{end}}
        {{else}}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
        {{end}}
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthInfo();
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthInfo() {
            const authInfo = document.getElementById('auth-info');
            const token = localStorage.getItem('token');
            
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    authInfo.innerHTML = `<strong>${payload.username}</strong> | 
                        <a href="#" onclick="logout()" style="color: #d32f2f;">–í—ã–π—Ç–∏</a>`;
                } catch (e) {
                    authInfo.innerHTML = `
                        <a href="/login">–í–æ–π—Ç–∏</a> | 
                        <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>`;
                }
            } else {
                authInfo.innerHTML = `
                    <a href="/login">–í–æ–π—Ç–∏</a> | 
                    <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>`;
            }
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            localStorage.removeItem('token');
            updateAuthInfo();
            location.reload();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
        async function createPost() {
            const content = document.getElementById('post-content').value.trim();
            const token = localStorage.getItem('token');

            if (!token) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
                window.location.href = '/login';
                return;
            }

            if (!content) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞!');
                return;
            }

            const response = await fetch('/api/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ content: content })
            });

            if (response.ok) {
                document.getElementById('post-content').value = '';
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞');
            }
        }

        // –õ–∞–π–∫ –ø–æ—Å—Ç–∞
        async function likePost(postId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏!');
                window.location.href = '/login';
                return;
            }

            const button = document.querySelector(`[data-post-id="${postId}"]`);
            button.disabled = true;

            try {
                const response = await fetch(`/api/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤
                    const likesSpan = document.getElementById(`likes-${postId}`);
                    if (likesSpan) {
                        const currentLikes = parseInt(likesSpan.textContent) || 0;
                        likesSpan.textContent = result.liked ? currentLikes + 1 : currentLikes - 1;
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫
                    setTimeout(() => location.reload(), 500);
                }
            } catch (error) {
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
            } finally {
                button.disabled = false;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            const button = event.target;
            
            if (commentsSection.style.display === 'none') {
                commentsSection.style.display = 'block';
                button.textContent = '–°–∫—Ä—ã—Ç—å';
                loadComments(postId);
            } else {
                commentsSection.style.display = 'none';
                button.textContent = '–û—Ç–≤–µ—Ç–∏—Ç—å';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        async function loadComments(postId) {
            const commentsList = document.getElementById(`comments-list-${postId}`);
            
            if (!commentsList) return;
            
            commentsList.innerHTML = '<div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const response = await fetch(`/api/posts/${postId}/comments`);
                
                if (response.ok) {
                    const comments = await response.json();
                    
                    if (!comments || comments.length === 0) {
                        commentsList.innerHTML = '<div style="color: #666;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    } else {
                        let html = '';
                        comments.forEach(comment => {
                            const userName = comment.user ? 
                                (comment.user.display_name || comment.user.username || '–ê–Ω–æ–Ω–∏–º') : 
                                '–ê–Ω–æ–Ω–∏–º';
                            const date = new Date(comment.created_at).toLocaleString('ru-RU');
                            
                            html += `
                            <div class="comment">
                                <div class="comment-author">${userName}</div>
                                <div class="comment-content">${comment.content}</div>
                                <div class="comment-date">${date}</div>
                            </div>`;
                        });
                        commentsList.innerHTML = html;
                    }
                } else {
                    commentsList.innerHTML = '<div style="color: #666;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                }
            } catch (error) {
                commentsList.innerHTML = '<div style="color: #666;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        async function addComment(postId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å!');
                window.location.href = '/login';
                return;
            }
            
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            
            if (!content) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è!');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            
            try {
                const response = await fetch(`/api/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ content: content })
                });
                
                if (response.ok) {
                    input.value = '';
                    loadComments(postId);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞');
            } finally {
                button.disabled = false;
            }
        }
    </script>
</body>
</html>